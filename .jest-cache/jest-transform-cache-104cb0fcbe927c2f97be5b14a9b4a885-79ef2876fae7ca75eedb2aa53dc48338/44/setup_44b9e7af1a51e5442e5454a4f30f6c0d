cd1d9102caf74ed5ad245a6bf6c6e33e
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.validateIdFormat = exports.validateEmailFormat = exports.validateSafeString = exports.delay = exports.createTestData = exports.validateApiResponse = exports.createFirebaseMock = exports.cleanupMocks = exports.mockErrorHandler = exports.mockAuthMiddleware = exports.createMockResponse = exports.createMockRequest = void 0;
// Mock Firebase Admin
jest.mock('firebase-admin', () => ({
    initializeApp: jest.fn(),
    getApps: jest.fn(() => []),
    getApp: jest.fn(),
    apps: [], // Agregar esta propiedad
    credential: {
        cert: jest.fn()
    },
    auth: jest.fn(() => ({
        verifyIdToken: jest.fn(),
        createCustomToken: jest.fn(),
        getUser: jest.fn(),
        getUserByEmail: jest.fn(),
        listUsers: jest.fn(),
        createUser: jest.fn(),
        updateUser: jest.fn(),
        deleteUser: jest.fn(),
        setCustomUserClaims: jest.fn()
    })),
    firestore: jest.fn(() => ({
        collection: jest.fn(() => ({
            doc: jest.fn(() => ({
                get: jest.fn(),
                set: jest.fn(),
                update: jest.fn(),
                delete: jest.fn()
            })),
            where: jest.fn(() => ({
                get: jest.fn(),
                orderBy: jest.fn(() => ({
                    get: jest.fn(),
                    limit: jest.fn(() => ({
                        get: jest.fn()
                    }))
                }))
            })),
            orderBy: jest.fn(() => ({
                get: jest.fn(),
                limit: jest.fn(() => ({
                    get: jest.fn()
                }))
            })),
            limit: jest.fn(() => ({
                get: jest.fn()
            })),
            get: jest.fn()
        }))
    })),
    getFirestore: jest.fn(() => ({
        collection: jest.fn(() => ({
            doc: jest.fn(() => ({
                get: jest.fn(),
                set: jest.fn(),
                update: jest.fn(),
                delete: jest.fn()
            })),
            where: jest.fn(() => ({
                get: jest.fn(),
                orderBy: jest.fn(() => ({
                    get: jest.fn(),
                    limit: jest.fn(() => ({
                        get: jest.fn()
                    }))
                }))
            })),
            orderBy: jest.fn(() => ({
                get: jest.fn(),
                limit: jest.fn(() => ({
                    get: jest.fn()
                }))
            })),
            limit: jest.fn(() => ({
                get: jest.fn()
            })),
            get: jest.fn()
        }))
    }))
}));
// Jest setup file for MussikOn API tests
const dotenv_1 = __importDefault(require("dotenv"));
const loggerService_1 = require("../services/loggerService");
// Load environment variables for testing
dotenv_1.default.config({ path: '.env.test' });
// 🆕 CONFIGURACIÓN MEJORADA DEL SETUP
// Setup any global test configuration
loggerService_1.logger.info('Setting up test environment...', { context: 'TestSetup' });
// Mock console methods to reduce noise in tests
jest.spyOn(console, 'log').mockImplementation(() => { });
jest.spyOn(console, 'info').mockImplementation(() => { });
jest.spyOn(console, 'warn').mockImplementation(() => { });
jest.spyOn(console, 'error').mockImplementation(() => { });
// Global test utilities
const createMockRequest = (overrides = {}) => (Object.assign({ body: {}, params: {}, query: {}, headers: {}, user: null }, overrides));
exports.createMockRequest = createMockRequest;
const createMockResponse = () => {
    const res = {};
    res.status = jest.fn().mockReturnValue(res);
    res.json = jest.fn().mockReturnValue(res);
    res.send = jest.fn().mockReturnValue(res);
    res.end = jest.fn().mockReturnValue(res);
    return res;
};
exports.createMockResponse = createMockResponse;
// Mock middleware
const mockAuthMiddleware = (req, res, next) => {
    req.user = {
        id: 'test-user-id',
        email: 'test@example.com',
        role: 'usuario'
    };
    next();
};
exports.mockAuthMiddleware = mockAuthMiddleware;
// Mock error handler
const mockErrorHandler = (err, req, res, next) => {
    res.status(500).json({
        success: false,
        message: err.message || 'Internal server error'
    });
};
exports.mockErrorHandler = mockErrorHandler;
// 🆕 UTILIDADES ADICIONALES PARA TESTS MEJORADOS
// Función para limpiar mocks después de cada test
const cleanupMocks = () => {
    jest.clearAllMocks();
    jest.resetAllMocks();
};
exports.cleanupMocks = cleanupMocks;
// Función para crear un mock de Firebase más realista
const createFirebaseMock = () => ({
    collection: jest.fn().mockReturnValue({
        doc: jest.fn().mockReturnValue({
            get: jest.fn().mockResolvedValue({
                exists: true,
                data: jest.fn().mockReturnValue({})
            }),
            set: jest.fn().mockResolvedValue({}),
            update: jest.fn().mockResolvedValue({}),
            delete: jest.fn().mockResolvedValue({})
        }),
        where: jest.fn().mockReturnThis(),
        orderBy: jest.fn().mockReturnThis(),
        limit: jest.fn().mockReturnThis(),
        get: jest.fn().mockResolvedValue({
            docs: [],
            size: 0
        }),
        add: jest.fn().mockResolvedValue({
            id: 'generated-id'
        })
    })
});
exports.createFirebaseMock = createFirebaseMock;
// Función para validar respuestas de API
const validateApiResponse = (response, expectedSuccess, expectedMessage) => {
    expect(response).toHaveProperty('success', expectedSuccess);
    if (expectedMessage) {
        expect(response).toHaveProperty('message', expectedMessage);
    }
};
exports.validateApiResponse = validateApiResponse;
// Función para crear datos de prueba válidos
exports.createTestData = {
    user: {
        id: 'test-user-id',
        email: 'test@example.com',
        role: 'usuario',
        name: 'Test User'
    },
    rating: {
        eventId: 'event123',
        musicianId: 'musician123',
        rating: 5,
        review: 'Excellent performance!',
        category: 'musician'
    },
    payment: {
        amount: 1000,
        currency: 'RD$',
        description: 'Test payment'
    }
};
// Función para simular delays en tests
const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));
exports.delay = delay;
// Función para validar que un string no contenga caracteres peligrosos
const validateSafeString = (str) => {
    const dangerousPatterns = [
        /<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, // XSS scripts
        /javascript:/gi, // JavaScript protocol
        /on\w+\s*=/gi, // Event handlers
        /data:text\/html/gi, // Data URLs
        /vbscript:/gi, // VBScript
        /expression\s*\(/gi, // CSS expressions
    ];
    return !dangerousPatterns.some(pattern => pattern.test(str));
};
exports.validateSafeString = validateSafeString;
// Función para validar formato de email
const validateEmailFormat = (email) => {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
};
exports.validateEmailFormat = validateEmailFormat;
// Función para validar formato de ID
const validateIdFormat = (id) => {
    const idRegex = /^[a-zA-Z0-9_-]{3,50}$/;
    return idRegex.test(id);
};
exports.validateIdFormat = validateIdFormat;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXHNyY1xcQVBQX011c3Npa09uXFxBUFBfTXVzc2lrT25fRXhwcmVzc1xcc3JjXFxfX3Rlc3RzX19cXHNldHVwLnRzIiwibWFwcGluZ3MiOiI7Ozs7OztBQU9BLHNCQUFzQjtBQUN0QixJQUFJLENBQUMsSUFBSSxDQUFDLGdCQUFnQixFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUM7SUFDakMsYUFBYSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7SUFDeEIsT0FBTyxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsRUFBRSxDQUFDO0lBQzFCLE1BQU0sRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO0lBQ2pCLElBQUksRUFBRSxFQUFFLEVBQUUseUJBQXlCO0lBQ25DLFVBQVUsRUFBRTtRQUNWLElBQUksRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO0tBQ2hCO0lBQ0QsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQztRQUNuQixhQUFhLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtRQUN4QixpQkFBaUIsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1FBQzVCLE9BQU8sRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1FBQ2xCLGNBQWMsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1FBQ3pCLFNBQVMsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1FBQ3BCLFVBQVUsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1FBQ3JCLFVBQVUsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1FBQ3JCLFVBQVUsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1FBQ3JCLG1CQUFtQixFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7S0FDL0IsQ0FBQyxDQUFDO0lBQ0gsU0FBUyxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQztRQUN4QixVQUFVLEVBQUUsSUFBSSxDQUFDLEVBQUUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDO1lBQ3pCLEdBQUcsRUFBRSxJQUFJLENBQUMsRUFBRSxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUM7Z0JBQ2xCLEdBQUcsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO2dCQUNkLEdBQUcsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO2dCQUNkLE1BQU0sRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO2dCQUNqQixNQUFNLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTthQUNsQixDQUFDLENBQUM7WUFDSCxLQUFLLEVBQUUsSUFBSSxDQUFDLEVBQUUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDO2dCQUNwQixHQUFHLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtnQkFDZCxPQUFPLEVBQUUsSUFBSSxDQUFDLEVBQUUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDO29CQUN0QixHQUFHLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtvQkFDZCxLQUFLLEVBQUUsSUFBSSxDQUFDLEVBQUUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDO3dCQUNwQixHQUFHLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtxQkFDZixDQUFDLENBQUM7aUJBQ0osQ0FBQyxDQUFDO2FBQ0osQ0FBQyxDQUFDO1lBQ0gsT0FBTyxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQztnQkFDdEIsR0FBRyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7Z0JBQ2QsS0FBSyxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQztvQkFDcEIsR0FBRyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7aUJBQ2YsQ0FBQyxDQUFDO2FBQ0osQ0FBQyxDQUFDO1lBQ0gsS0FBSyxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQztnQkFDcEIsR0FBRyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7YUFDZixDQUFDLENBQUM7WUFDSCxHQUFHLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtTQUNmLENBQUMsQ0FBQztLQUNKLENBQUMsQ0FBQztJQUNILFlBQVksRUFBRSxJQUFJLENBQUMsRUFBRSxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUM7UUFDM0IsVUFBVSxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQztZQUN6QixHQUFHLEVBQUUsSUFBSSxDQUFDLEVBQUUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDO2dCQUNsQixHQUFHLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtnQkFDZCxHQUFHLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtnQkFDZCxNQUFNLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtnQkFDakIsTUFBTSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7YUFDbEIsQ0FBQyxDQUFDO1lBQ0gsS0FBSyxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQztnQkFDcEIsR0FBRyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7Z0JBQ2QsT0FBTyxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQztvQkFDdEIsR0FBRyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7b0JBQ2QsS0FBSyxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQzt3QkFDcEIsR0FBRyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7cUJBQ2YsQ0FBQyxDQUFDO2lCQUNKLENBQUMsQ0FBQzthQUNKLENBQUMsQ0FBQztZQUNILE9BQU8sRUFBRSxJQUFJLENBQUMsRUFBRSxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUM7Z0JBQ3RCLEdBQUcsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO2dCQUNkLEtBQUssRUFBRSxJQUFJLENBQUMsRUFBRSxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUM7b0JBQ3BCLEdBQUcsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO2lCQUNmLENBQUMsQ0FBQzthQUNKLENBQUMsQ0FBQztZQUNILEtBQUssRUFBRSxJQUFJLENBQUMsRUFBRSxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUM7Z0JBQ3BCLEdBQUcsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO2FBQ2YsQ0FBQyxDQUFDO1lBQ0gsR0FBRyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7U0FDZixDQUFDLENBQUM7S0FDSixDQUFDLENBQUM7Q0FDSixDQUFDLENBQUMsQ0FBQztBQXJGSix5Q0FBeUM7QUFDekMsb0RBQTRCO0FBQzVCLDZEQUFtRDtBQUVuRCx5Q0FBeUM7QUFDekMsZ0JBQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxJQUFJLEVBQUUsV0FBVyxFQUFFLENBQUMsQ0FBQztBQWtGckMsc0NBQXNDO0FBQ3RDLHNDQUFzQztBQUN0QyxzQkFBTSxDQUFDLElBQUksQ0FBQyxnQ0FBZ0MsRUFBRSxFQUFFLE9BQU8sRUFBRSxXQUFXLEVBQUUsQ0FBQyxDQUFDO0FBRXhFLGdEQUFnRDtBQUNoRCxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sRUFBRSxLQUFLLENBQUMsQ0FBQyxrQkFBa0IsQ0FBQyxHQUFHLEVBQUUsR0FBRSxDQUFDLENBQUMsQ0FBQztBQUN4RCxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sRUFBRSxNQUFNLENBQUMsQ0FBQyxrQkFBa0IsQ0FBQyxHQUFHLEVBQUUsR0FBRSxDQUFDLENBQUMsQ0FBQztBQUN6RCxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sRUFBRSxNQUFNLENBQUMsQ0FBQyxrQkFBa0IsQ0FBQyxHQUFHLEVBQUUsR0FBRSxDQUFDLENBQUMsQ0FBQztBQUN6RCxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sRUFBRSxPQUFPLENBQUMsQ0FBQyxrQkFBa0IsQ0FBQyxHQUFHLEVBQUUsR0FBRSxDQUFDLENBQUMsQ0FBQztBQUUxRCx3QkFBd0I7QUFDakIsTUFBTSxpQkFBaUIsR0FBRyxDQUFDLFlBQWlCLEVBQUUsRUFBRSxFQUFFLENBQUMsaUJBQ3hELElBQUksRUFBRSxFQUFFLEVBQ1IsTUFBTSxFQUFFLEVBQUUsRUFDVixLQUFLLEVBQUUsRUFBRSxFQUNULE9BQU8sRUFBRSxFQUFFLEVBQ1gsSUFBSSxFQUFFLElBQUksSUFDUCxTQUFTLEVBQ1osQ0FBQztBQVBVLFFBQUEsaUJBQWlCLHFCQU8zQjtBQUVJLE1BQU0sa0JBQWtCLEdBQUcsR0FBRyxFQUFFO0lBQ3JDLE1BQU0sR0FBRyxHQUFRLEVBQUUsQ0FBQztJQUNwQixHQUFHLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxlQUFlLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDNUMsR0FBRyxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsZUFBZSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQzFDLEdBQUcsQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGVBQWUsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUMxQyxHQUFHLENBQUMsR0FBRyxHQUFHLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxlQUFlLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDekMsT0FBTyxHQUFHLENBQUM7QUFDYixDQUFDLENBQUM7QUFQVyxRQUFBLGtCQUFrQixzQkFPN0I7QUFFRixrQkFBa0I7QUFDWCxNQUFNLGtCQUFrQixHQUFHLENBQUMsR0FBUSxFQUFFLEdBQVEsRUFBRSxJQUFTLEVBQUUsRUFBRTtJQUNsRSxHQUFHLENBQUMsSUFBSSxHQUFHO1FBQ1QsRUFBRSxFQUFFLGNBQWM7UUFDbEIsS0FBSyxFQUFFLGtCQUFrQjtRQUN6QixJQUFJLEVBQUUsU0FBUztLQUNoQixDQUFDO0lBQ0YsSUFBSSxFQUFFLENBQUM7QUFDVCxDQUFDLENBQUM7QUFQVyxRQUFBLGtCQUFrQixzQkFPN0I7QUFFRixxQkFBcUI7QUFDZCxNQUFNLGdCQUFnQixHQUFHLENBQUMsR0FBUSxFQUFFLEdBQVEsRUFBRSxHQUFRLEVBQUUsSUFBUyxFQUFFLEVBQUU7SUFDMUUsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7UUFDbkIsT0FBTyxFQUFFLEtBQUs7UUFDZCxPQUFPLEVBQUUsR0FBRyxDQUFDLE9BQU8sSUFBSSx1QkFBdUI7S0FDaEQsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDO0FBTFcsUUFBQSxnQkFBZ0Isb0JBSzNCO0FBRUYsaURBQWlEO0FBRWpELGtEQUFrRDtBQUMzQyxNQUFNLFlBQVksR0FBRyxHQUFHLEVBQUU7SUFDL0IsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO0lBQ3JCLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztBQUN2QixDQUFDLENBQUM7QUFIVyxRQUFBLFlBQVksZ0JBR3ZCO0FBRUYsc0RBQXNEO0FBQy9DLE1BQU0sa0JBQWtCLEdBQUcsR0FBRyxFQUFFLENBQUMsQ0FBQztJQUN2QyxVQUFVLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGVBQWUsQ0FBQztRQUNwQyxHQUFHLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGVBQWUsQ0FBQztZQUM3QixHQUFHLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGlCQUFpQixDQUFDO2dCQUMvQixNQUFNLEVBQUUsSUFBSTtnQkFDWixJQUFJLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGVBQWUsQ0FBQyxFQUFFLENBQUM7YUFDcEMsQ0FBQztZQUNGLEdBQUcsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsaUJBQWlCLENBQUMsRUFBRSxDQUFDO1lBQ3BDLE1BQU0sRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsaUJBQWlCLENBQUMsRUFBRSxDQUFDO1lBQ3ZDLE1BQU0sRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsaUJBQWlCLENBQUMsRUFBRSxDQUFDO1NBQ3hDLENBQUM7UUFDRixLQUFLLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGNBQWMsRUFBRTtRQUNqQyxPQUFPLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGNBQWMsRUFBRTtRQUNuQyxLQUFLLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGNBQWMsRUFBRTtRQUNqQyxHQUFHLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGlCQUFpQixDQUFDO1lBQy9CLElBQUksRUFBRSxFQUFFO1lBQ1IsSUFBSSxFQUFFLENBQUM7U0FDUixDQUFDO1FBQ0YsR0FBRyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQztZQUMvQixFQUFFLEVBQUUsY0FBYztTQUNuQixDQUFDO0tBQ0gsQ0FBQztDQUNILENBQUMsQ0FBQztBQXRCVSxRQUFBLGtCQUFrQixzQkFzQjVCO0FBRUgseUNBQXlDO0FBQ2xDLE1BQU0sbUJBQW1CLEdBQUcsQ0FBQyxRQUFhLEVBQUUsZUFBd0IsRUFBRSxlQUF3QixFQUFFLEVBQUU7SUFDdkcsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDLGNBQWMsQ0FBQyxTQUFTLEVBQUUsZUFBZSxDQUFDLENBQUM7SUFDNUQsSUFBSSxlQUFlLEVBQUUsQ0FBQztRQUNwQixNQUFNLENBQUMsUUFBUSxDQUFDLENBQUMsY0FBYyxDQUFDLFNBQVMsRUFBRSxlQUFlLENBQUMsQ0FBQztJQUM5RCxDQUFDO0FBQ0gsQ0FBQyxDQUFDO0FBTFcsUUFBQSxtQkFBbUIsdUJBSzlCO0FBRUYsNkNBQTZDO0FBQ2hDLFFBQUEsY0FBYyxHQUFHO0lBQzVCLElBQUksRUFBRTtRQUNKLEVBQUUsRUFBRSxjQUFjO1FBQ2xCLEtBQUssRUFBRSxrQkFBa0I7UUFDekIsSUFBSSxFQUFFLFNBQVM7UUFDZixJQUFJLEVBQUUsV0FBVztLQUNsQjtJQUNELE1BQU0sRUFBRTtRQUNOLE9BQU8sRUFBRSxVQUFVO1FBQ25CLFVBQVUsRUFBRSxhQUFhO1FBQ3pCLE1BQU0sRUFBRSxDQUFDO1FBQ1QsTUFBTSxFQUFFLHdCQUF3QjtRQUNoQyxRQUFRLEVBQUUsVUFBVTtLQUNyQjtJQUNELE9BQU8sRUFBRTtRQUNQLE1BQU0sRUFBRSxJQUFJO1FBQ1osUUFBUSxFQUFFLEtBQUs7UUFDZixXQUFXLEVBQUUsY0FBYztLQUM1QjtDQUNGLENBQUM7QUFFRix1Q0FBdUM7QUFDaEMsTUFBTSxLQUFLLEdBQUcsQ0FBQyxFQUFVLEVBQUUsRUFBRSxDQUFDLElBQUksT0FBTyxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsVUFBVSxDQUFDLE9BQU8sRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDO0FBQXhFLFFBQUEsS0FBSyxTQUFtRTtBQUVyRix1RUFBdUU7QUFDaEUsTUFBTSxrQkFBa0IsR0FBRyxDQUFDLEdBQVcsRUFBRSxFQUFFO0lBQ2hELE1BQU0saUJBQWlCLEdBQUc7UUFDeEIscURBQXFELEVBQUUsY0FBYztRQUNyRSxlQUFlLEVBQUUsc0JBQXNCO1FBQ3ZDLGFBQWEsRUFBRSxpQkFBaUI7UUFDaEMsbUJBQW1CLEVBQUUsWUFBWTtRQUNqQyxhQUFhLEVBQUUsV0FBVztRQUMxQixtQkFBbUIsRUFBRSxrQkFBa0I7S0FDeEMsQ0FBQztJQUVGLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7QUFDL0QsQ0FBQyxDQUFDO0FBWFcsUUFBQSxrQkFBa0Isc0JBVzdCO0FBRUYsd0NBQXdDO0FBQ2pDLE1BQU0sbUJBQW1CLEdBQUcsQ0FBQyxLQUFhLEVBQUUsRUFBRTtJQUNuRCxNQUFNLFVBQVUsR0FBRyw0QkFBNEIsQ0FBQztJQUNoRCxPQUFPLFVBQVUsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7QUFDaEMsQ0FBQyxDQUFDO0FBSFcsUUFBQSxtQkFBbUIsdUJBRzlCO0FBRUYscUNBQXFDO0FBQzlCLE1BQU0sZ0JBQWdCLEdBQUcsQ0FBQyxFQUFVLEVBQUUsRUFBRTtJQUM3QyxNQUFNLE9BQU8sR0FBRyx1QkFBdUIsQ0FBQztJQUN4QyxPQUFPLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7QUFDMUIsQ0FBQyxDQUFDO0FBSFcsUUFBQSxnQkFBZ0Isb0JBRzNCIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxzcmNcXEFQUF9NdXNzaWtPblxcQVBQX011c3Npa09uX0V4cHJlc3NcXHNyY1xcX190ZXN0c19fXFxzZXR1cC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBKZXN0IHNldHVwIGZpbGUgZm9yIE11c3Npa09uIEFQSSB0ZXN0c1xuaW1wb3J0IGRvdGVudiBmcm9tICdkb3RlbnYnO1xuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSAnLi4vc2VydmljZXMvbG9nZ2VyU2VydmljZSc7XG5cbi8vIExvYWQgZW52aXJvbm1lbnQgdmFyaWFibGVzIGZvciB0ZXN0aW5nXG5kb3RlbnYuY29uZmlnKHsgcGF0aDogJy5lbnYudGVzdCcgfSk7XG5cbi8vIE1vY2sgRmlyZWJhc2UgQWRtaW5cbmplc3QubW9jaygnZmlyZWJhc2UtYWRtaW4nLCAoKSA9PiAoe1xuICBpbml0aWFsaXplQXBwOiBqZXN0LmZuKCksXG4gIGdldEFwcHM6IGplc3QuZm4oKCkgPT4gW10pLFxuICBnZXRBcHA6IGplc3QuZm4oKSxcbiAgYXBwczogW10sIC8vIEFncmVnYXIgZXN0YSBwcm9waWVkYWRcbiAgY3JlZGVudGlhbDoge1xuICAgIGNlcnQ6IGplc3QuZm4oKVxuICB9LFxuICBhdXRoOiBqZXN0LmZuKCgpID0+ICh7XG4gICAgdmVyaWZ5SWRUb2tlbjogamVzdC5mbigpLFxuICAgIGNyZWF0ZUN1c3RvbVRva2VuOiBqZXN0LmZuKCksXG4gICAgZ2V0VXNlcjogamVzdC5mbigpLFxuICAgIGdldFVzZXJCeUVtYWlsOiBqZXN0LmZuKCksXG4gICAgbGlzdFVzZXJzOiBqZXN0LmZuKCksXG4gICAgY3JlYXRlVXNlcjogamVzdC5mbigpLFxuICAgIHVwZGF0ZVVzZXI6IGplc3QuZm4oKSxcbiAgICBkZWxldGVVc2VyOiBqZXN0LmZuKCksXG4gICAgc2V0Q3VzdG9tVXNlckNsYWltczogamVzdC5mbigpXG4gIH0pKSxcbiAgZmlyZXN0b3JlOiBqZXN0LmZuKCgpID0+ICh7XG4gICAgY29sbGVjdGlvbjogamVzdC5mbigoKSA9PiAoe1xuICAgICAgZG9jOiBqZXN0LmZuKCgpID0+ICh7XG4gICAgICAgIGdldDogamVzdC5mbigpLFxuICAgICAgICBzZXQ6IGplc3QuZm4oKSxcbiAgICAgICAgdXBkYXRlOiBqZXN0LmZuKCksXG4gICAgICAgIGRlbGV0ZTogamVzdC5mbigpXG4gICAgICB9KSksXG4gICAgICB3aGVyZTogamVzdC5mbigoKSA9PiAoe1xuICAgICAgICBnZXQ6IGplc3QuZm4oKSxcbiAgICAgICAgb3JkZXJCeTogamVzdC5mbigoKSA9PiAoe1xuICAgICAgICAgIGdldDogamVzdC5mbigpLFxuICAgICAgICAgIGxpbWl0OiBqZXN0LmZuKCgpID0+ICh7XG4gICAgICAgICAgICBnZXQ6IGplc3QuZm4oKVxuICAgICAgICAgIH0pKVxuICAgICAgICB9KSlcbiAgICAgIH0pKSxcbiAgICAgIG9yZGVyQnk6IGplc3QuZm4oKCkgPT4gKHtcbiAgICAgICAgZ2V0OiBqZXN0LmZuKCksXG4gICAgICAgIGxpbWl0OiBqZXN0LmZuKCgpID0+ICh7XG4gICAgICAgICAgZ2V0OiBqZXN0LmZuKClcbiAgICAgICAgfSkpXG4gICAgICB9KSksXG4gICAgICBsaW1pdDogamVzdC5mbigoKSA9PiAoe1xuICAgICAgICBnZXQ6IGplc3QuZm4oKVxuICAgICAgfSkpLFxuICAgICAgZ2V0OiBqZXN0LmZuKClcbiAgICB9KSlcbiAgfSkpLFxuICBnZXRGaXJlc3RvcmU6IGplc3QuZm4oKCkgPT4gKHtcbiAgICBjb2xsZWN0aW9uOiBqZXN0LmZuKCgpID0+ICh7XG4gICAgICBkb2M6IGplc3QuZm4oKCkgPT4gKHtcbiAgICAgICAgZ2V0OiBqZXN0LmZuKCksXG4gICAgICAgIHNldDogamVzdC5mbigpLFxuICAgICAgICB1cGRhdGU6IGplc3QuZm4oKSxcbiAgICAgICAgZGVsZXRlOiBqZXN0LmZuKClcbiAgICAgIH0pKSxcbiAgICAgIHdoZXJlOiBqZXN0LmZuKCgpID0+ICh7XG4gICAgICAgIGdldDogamVzdC5mbigpLFxuICAgICAgICBvcmRlckJ5OiBqZXN0LmZuKCgpID0+ICh7XG4gICAgICAgICAgZ2V0OiBqZXN0LmZuKCksXG4gICAgICAgICAgbGltaXQ6IGplc3QuZm4oKCkgPT4gKHtcbiAgICAgICAgICAgIGdldDogamVzdC5mbigpXG4gICAgICAgICAgfSkpXG4gICAgICAgIH0pKVxuICAgICAgfSkpLFxuICAgICAgb3JkZXJCeTogamVzdC5mbigoKSA9PiAoe1xuICAgICAgICBnZXQ6IGplc3QuZm4oKSxcbiAgICAgICAgbGltaXQ6IGplc3QuZm4oKCkgPT4gKHtcbiAgICAgICAgICBnZXQ6IGplc3QuZm4oKVxuICAgICAgICB9KSlcbiAgICAgIH0pKSxcbiAgICAgIGxpbWl0OiBqZXN0LmZuKCgpID0+ICh7XG4gICAgICAgIGdldDogamVzdC5mbigpXG4gICAgICB9KSksXG4gICAgICBnZXQ6IGplc3QuZm4oKVxuICAgIH0pKVxuICB9KSlcbn0pKTtcblxuLy8g8J+GlSBDT05GSUdVUkFDScOTTiBNRUpPUkFEQSBERUwgU0VUVVBcbi8vIFNldHVwIGFueSBnbG9iYWwgdGVzdCBjb25maWd1cmF0aW9uXG5sb2dnZXIuaW5mbygnU2V0dGluZyB1cCB0ZXN0IGVudmlyb25tZW50Li4uJywgeyBjb250ZXh0OiAnVGVzdFNldHVwJyB9KTtcblxuLy8gTW9jayBjb25zb2xlIG1ldGhvZHMgdG8gcmVkdWNlIG5vaXNlIGluIHRlc3RzXG5qZXN0LnNweU9uKGNvbnNvbGUsICdsb2cnKS5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4ge30pO1xuamVzdC5zcHlPbihjb25zb2xlLCAnaW5mbycpLm1vY2tJbXBsZW1lbnRhdGlvbigoKSA9PiB7fSk7XG5qZXN0LnNweU9uKGNvbnNvbGUsICd3YXJuJykubW9ja0ltcGxlbWVudGF0aW9uKCgpID0+IHt9KTtcbmplc3Quc3B5T24oY29uc29sZSwgJ2Vycm9yJykubW9ja0ltcGxlbWVudGF0aW9uKCgpID0+IHt9KTtcblxuLy8gR2xvYmFsIHRlc3QgdXRpbGl0aWVzXG5leHBvcnQgY29uc3QgY3JlYXRlTW9ja1JlcXVlc3QgPSAob3ZlcnJpZGVzOiBhbnkgPSB7fSkgPT4gKHtcbiAgYm9keToge30sXG4gIHBhcmFtczoge30sXG4gIHF1ZXJ5OiB7fSxcbiAgaGVhZGVyczoge30sXG4gIHVzZXI6IG51bGwsXG4gIC4uLm92ZXJyaWRlc1xufSk7XG5cbmV4cG9ydCBjb25zdCBjcmVhdGVNb2NrUmVzcG9uc2UgPSAoKSA9PiB7XG4gIGNvbnN0IHJlczogYW55ID0ge307XG4gIHJlcy5zdGF0dXMgPSBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKHJlcyk7XG4gIHJlcy5qc29uID0gamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZShyZXMpO1xuICByZXMuc2VuZCA9IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUocmVzKTtcbiAgcmVzLmVuZCA9IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUocmVzKTtcbiAgcmV0dXJuIHJlcztcbn07XG5cbi8vIE1vY2sgbWlkZGxld2FyZVxuZXhwb3J0IGNvbnN0IG1vY2tBdXRoTWlkZGxld2FyZSA9IChyZXE6IGFueSwgcmVzOiBhbnksIG5leHQ6IGFueSkgPT4ge1xuICByZXEudXNlciA9IHtcbiAgICBpZDogJ3Rlc3QtdXNlci1pZCcsXG4gICAgZW1haWw6ICd0ZXN0QGV4YW1wbGUuY29tJyxcbiAgICByb2xlOiAndXN1YXJpbydcbiAgfTtcbiAgbmV4dCgpO1xufTtcblxuLy8gTW9jayBlcnJvciBoYW5kbGVyXG5leHBvcnQgY29uc3QgbW9ja0Vycm9ySGFuZGxlciA9IChlcnI6IGFueSwgcmVxOiBhbnksIHJlczogYW55LCBuZXh0OiBhbnkpID0+IHtcbiAgcmVzLnN0YXR1cyg1MDApLmpzb24oe1xuICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgIG1lc3NhZ2U6IGVyci5tZXNzYWdlIHx8ICdJbnRlcm5hbCBzZXJ2ZXIgZXJyb3InXG4gIH0pO1xufTtcblxuLy8g8J+GlSBVVElMSURBREVTIEFESUNJT05BTEVTIFBBUkEgVEVTVFMgTUVKT1JBRE9TXG5cbi8vIEZ1bmNpw7NuIHBhcmEgbGltcGlhciBtb2NrcyBkZXNwdcOpcyBkZSBjYWRhIHRlc3RcbmV4cG9ydCBjb25zdCBjbGVhbnVwTW9ja3MgPSAoKSA9PiB7XG4gIGplc3QuY2xlYXJBbGxNb2NrcygpO1xuICBqZXN0LnJlc2V0QWxsTW9ja3MoKTtcbn07XG5cbi8vIEZ1bmNpw7NuIHBhcmEgY3JlYXIgdW4gbW9jayBkZSBGaXJlYmFzZSBtw6FzIHJlYWxpc3RhXG5leHBvcnQgY29uc3QgY3JlYXRlRmlyZWJhc2VNb2NrID0gKCkgPT4gKHtcbiAgY29sbGVjdGlvbjogamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZSh7XG4gICAgZG9jOiBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKHtcbiAgICAgIGdldDogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHtcbiAgICAgICAgZXhpc3RzOiB0cnVlLFxuICAgICAgICBkYXRhOiBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKHt9KVxuICAgICAgfSksXG4gICAgICBzZXQ6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh7fSksXG4gICAgICB1cGRhdGU6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh7fSksXG4gICAgICBkZWxldGU6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh7fSlcbiAgICB9KSxcbiAgICB3aGVyZTogamVzdC5mbigpLm1vY2tSZXR1cm5UaGlzKCksXG4gICAgb3JkZXJCeTogamVzdC5mbigpLm1vY2tSZXR1cm5UaGlzKCksXG4gICAgbGltaXQ6IGplc3QuZm4oKS5tb2NrUmV0dXJuVGhpcygpLFxuICAgIGdldDogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHtcbiAgICAgIGRvY3M6IFtdLFxuICAgICAgc2l6ZTogMFxuICAgIH0pLFxuICAgIGFkZDogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHtcbiAgICAgIGlkOiAnZ2VuZXJhdGVkLWlkJ1xuICAgIH0pXG4gIH0pXG59KTtcblxuLy8gRnVuY2nDs24gcGFyYSB2YWxpZGFyIHJlc3B1ZXN0YXMgZGUgQVBJXG5leHBvcnQgY29uc3QgdmFsaWRhdGVBcGlSZXNwb25zZSA9IChyZXNwb25zZTogYW55LCBleHBlY3RlZFN1Y2Nlc3M6IGJvb2xlYW4sIGV4cGVjdGVkTWVzc2FnZT86IHN0cmluZykgPT4ge1xuICBleHBlY3QocmVzcG9uc2UpLnRvSGF2ZVByb3BlcnR5KCdzdWNjZXNzJywgZXhwZWN0ZWRTdWNjZXNzKTtcbiAgaWYgKGV4cGVjdGVkTWVzc2FnZSkge1xuICAgIGV4cGVjdChyZXNwb25zZSkudG9IYXZlUHJvcGVydHkoJ21lc3NhZ2UnLCBleHBlY3RlZE1lc3NhZ2UpO1xuICB9XG59O1xuXG4vLyBGdW5jacOzbiBwYXJhIGNyZWFyIGRhdG9zIGRlIHBydWViYSB2w6FsaWRvc1xuZXhwb3J0IGNvbnN0IGNyZWF0ZVRlc3REYXRhID0ge1xuICB1c2VyOiB7XG4gICAgaWQ6ICd0ZXN0LXVzZXItaWQnLFxuICAgIGVtYWlsOiAndGVzdEBleGFtcGxlLmNvbScsXG4gICAgcm9sZTogJ3VzdWFyaW8nLFxuICAgIG5hbWU6ICdUZXN0IFVzZXInXG4gIH0sXG4gIHJhdGluZzoge1xuICAgIGV2ZW50SWQ6ICdldmVudDEyMycsXG4gICAgbXVzaWNpYW5JZDogJ211c2ljaWFuMTIzJyxcbiAgICByYXRpbmc6IDUsXG4gICAgcmV2aWV3OiAnRXhjZWxsZW50IHBlcmZvcm1hbmNlIScsXG4gICAgY2F0ZWdvcnk6ICdtdXNpY2lhbidcbiAgfSxcbiAgcGF5bWVudDoge1xuICAgIGFtb3VudDogMTAwMCxcbiAgICBjdXJyZW5jeTogJ1JEJCcsXG4gICAgZGVzY3JpcHRpb246ICdUZXN0IHBheW1lbnQnXG4gIH1cbn07XG5cbi8vIEZ1bmNpw7NuIHBhcmEgc2ltdWxhciBkZWxheXMgZW4gdGVzdHNcbmV4cG9ydCBjb25zdCBkZWxheSA9IChtczogbnVtYmVyKSA9PiBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgbXMpKTtcblxuLy8gRnVuY2nDs24gcGFyYSB2YWxpZGFyIHF1ZSB1biBzdHJpbmcgbm8gY29udGVuZ2EgY2FyYWN0ZXJlcyBwZWxpZ3Jvc29zXG5leHBvcnQgY29uc3QgdmFsaWRhdGVTYWZlU3RyaW5nID0gKHN0cjogc3RyaW5nKSA9PiB7XG4gIGNvbnN0IGRhbmdlcm91c1BhdHRlcm5zID0gW1xuICAgIC88c2NyaXB0XFxiW148XSooPzooPyE8XFwvc2NyaXB0Pik8W148XSopKjxcXC9zY3JpcHQ+L2dpLCAvLyBYU1Mgc2NyaXB0c1xuICAgIC9qYXZhc2NyaXB0Oi9naSwgLy8gSmF2YVNjcmlwdCBwcm90b2NvbFxuICAgIC9vblxcdytcXHMqPS9naSwgLy8gRXZlbnQgaGFuZGxlcnNcbiAgICAvZGF0YTp0ZXh0XFwvaHRtbC9naSwgLy8gRGF0YSBVUkxzXG4gICAgL3Zic2NyaXB0Oi9naSwgLy8gVkJTY3JpcHRcbiAgICAvZXhwcmVzc2lvblxccypcXCgvZ2ksIC8vIENTUyBleHByZXNzaW9uc1xuICBdO1xuICBcbiAgcmV0dXJuICFkYW5nZXJvdXNQYXR0ZXJucy5zb21lKHBhdHRlcm4gPT4gcGF0dGVybi50ZXN0KHN0cikpO1xufTtcblxuLy8gRnVuY2nDs24gcGFyYSB2YWxpZGFyIGZvcm1hdG8gZGUgZW1haWxcbmV4cG9ydCBjb25zdCB2YWxpZGF0ZUVtYWlsRm9ybWF0ID0gKGVtYWlsOiBzdHJpbmcpID0+IHtcbiAgY29uc3QgZW1haWxSZWdleCA9IC9eW15cXHNAXStAW15cXHNAXStcXC5bXlxcc0BdKyQvO1xuICByZXR1cm4gZW1haWxSZWdleC50ZXN0KGVtYWlsKTtcbn07XG5cbi8vIEZ1bmNpw7NuIHBhcmEgdmFsaWRhciBmb3JtYXRvIGRlIElEXG5leHBvcnQgY29uc3QgdmFsaWRhdGVJZEZvcm1hdCA9IChpZDogc3RyaW5nKSA9PiB7XG4gIGNvbnN0IGlkUmVnZXggPSAvXlthLXpBLVowLTlfLV17Myw1MH0kLztcbiAgcmV0dXJuIGlkUmVnZXgudGVzdChpZCk7XG59OyAiXSwidmVyc2lvbiI6M30=