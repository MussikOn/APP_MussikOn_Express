{"version":3,"names":["loggerService_1","cov_z6j1hptpd","s","require","multer_1","__importDefault","handleMulterError","error","req","res","next","f","default","MulterError","b","code","status","json","details","message","includes","logger","exports","validateImageFile","file","maxSize","size","allowedMimeTypes","mimetype","imageUpload","storage","memoryStorage","limits","fileSize","files","fileFilter","cb","Error","documentUpload","upload"],"sources":["C:\\src\\APP_MussikOn\\APP_MussikOn_Express\\src\\middleware\\uploadMiddleware.ts"],"sourcesContent":["import { Request, Response, NextFunction } from 'express';\r\nimport { logger } from '../services/loggerService';\r\nimport multer from 'multer';\r\n\r\n/**\r\n * Middleware para manejar errores de multer\r\n */\r\nexport const handleMulterError = (\r\n  error: any,\r\n  req: Request,\r\n  res: Response,\r\n  next: NextFunction\r\n) => {\r\n  if (error instanceof multer.MulterError) {\r\n    if (error.code === 'LIMIT_FILE_SIZE') {\r\n      res.status(400).json({\r\n        error: 'El archivo es demasiado grande',\r\n        details: 'El tamaño máximo permitido es 10MB',\r\n        code: 'FILE_TOO_LARGE',\r\n      });\r\n      return;\r\n    }\r\n\r\n    if (error.code === 'LIMIT_FILE_COUNT') {\r\n      res.status(400).json({\r\n        error: 'Demasiados archivos',\r\n        details: 'Solo se permite un archivo por vez',\r\n        code: 'TOO_MANY_FILES',\r\n      });\r\n      return;\r\n    }\r\n\r\n    res.status(400).json({\r\n      error: 'Error en la subida del archivo',\r\n      details: error.message,\r\n      code: 'UPLOAD_ERROR',\r\n    });\r\n    return;\r\n  }\r\n\r\n  if (error.message && error.message.includes('Tipo de archivo no permitido')) {\r\n    res.status(400).json({\r\n      error: 'Tipo de archivo no permitido',\r\n      details: 'Solo se permiten imágenes (JPEG, PNG, GIF, WebP, SVG)',\r\n      code: 'INVALID_FILE_TYPE',\r\n    });\r\n    return;\r\n  }\r\n\r\n  logger.error('[src/middleware/uploadMiddleware.ts] Error de subida:', error as Error);\r\n  res.status(500).json({\r\n    error: 'Error interno del servidor',\r\n    details: 'Error al procesar el archivo',\r\n    code: 'INTERNAL_ERROR',\r\n  });\r\n  return;\r\n};\r\n\r\n/**\r\n * Middleware para validar archivos antes de procesar\r\n */\r\nexport const validateImageFile = (\r\n  req: Request,\r\n  res: Response,\r\n  next: NextFunction\r\n): void => {\r\n  if (!req.file) {\r\n    res.status(400).json({\r\n      error: 'No se proporcionó ningún archivo',\r\n      code: 'NO_FILE',\r\n    });\r\n    return;\r\n  }\r\n\r\n  // Validar tamaño (máximo 10MB)\r\n  const maxSize = 10 * 1024 * 1024; // 10MB\r\n  if (req.file.size > maxSize) {\r\n    res.status(400).json({\r\n      error: 'El archivo es demasiado grande',\r\n      details: `Tamaño máximo: ${maxSize / 1024 / 1024}MB`,\r\n      code: 'FILE_TOO_LARGE',\r\n    });\r\n    return;\r\n  }\r\n\r\n  // Validar tipo MIME\r\n  const allowedMimeTypes = [\r\n    'image/jpeg',\r\n    'image/png',\r\n    'image/gif',\r\n    'image/webp',\r\n    'image/svg+xml',\r\n  ];\r\n\r\n  if (!allowedMimeTypes.includes(req.file.mimetype)) {\r\n    res.status(400).json({\r\n      error: 'Tipo de archivo no permitido',\r\n      details: 'Solo se permiten imágenes (JPEG, PNG, GIF, WebP, SVG)',\r\n      code: 'INVALID_FILE_TYPE',\r\n    });\r\n    return;\r\n  }\r\n\r\n  next();\r\n};\r\n\r\n/**\r\n * Configuración de multer para imágenes\r\n */\r\nexport const imageUpload = multer({\r\n  storage: multer.memoryStorage(),\r\n  limits: {\r\n    fileSize: 10 * 1024 * 1024, // 10MB\r\n    files: 1, // Solo un archivo\r\n  },\r\n  fileFilter: (req, file, cb) => {\r\n    const allowedMimeTypes = [\r\n      'image/jpeg',\r\n      'image/png',\r\n      'image/gif',\r\n      'image/webp',\r\n      'image/svg+xml',\r\n    ];\r\n\r\n    if (allowedMimeTypes.includes(file.mimetype)) {\r\n      cb(null, true);\r\n    } else {\r\n      cb(new Error('Tipo de archivo no permitido. Solo se permiten imágenes'));\r\n    }\r\n  },\r\n});\r\n\r\n/**\r\n * Configuración de multer para documentos (comprobantes de pago)\r\n */\r\nexport const documentUpload = multer({\r\n  storage: multer.memoryStorage(),\r\n  limits: {\r\n    fileSize: 10 * 1024 * 1024, // 10MB\r\n    files: 1, // Solo un archivo\r\n  },\r\n  fileFilter: (req, file, cb) => {\r\n    const allowedMimeTypes = [\r\n      'image/jpeg',\r\n      'image/png',\r\n      'image/gif',\r\n      'image/webp',\r\n      'application/pdf',\r\n    ];\r\n\r\n    if (allowedMimeTypes.includes(file.mimetype)) {\r\n      cb(null, true);\r\n    } else {\r\n      cb(new Error('Tipo de archivo no permitido. Solo se permiten imágenes y PDFs'));\r\n    }\r\n  },\r\n});\r\n\r\n// Exportación por defecto para compatibilidad\r\nexport const upload = documentUpload;\r\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AACA,MAAAA,eAAA;AAA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","ignoreList":[]}