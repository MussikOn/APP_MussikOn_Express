aad1570b704818435beb221ae6fcc534
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
// Mock de jsonwebtoken
jest.mock('jsonwebtoken');
const jsonwebtoken_1 = __importDefault(require("jsonwebtoken"));
const authMiddleware_1 = require("../middleware/authMiddleware");
const setup_1 = require("./setup");
describe('AuthMiddleware', () => {
    let mockRequest;
    let mockResponse;
    let mockNext;
    let mockJson;
    let mockStatus;
    beforeEach(() => {
        mockJson = jest.fn();
        mockStatus = jest.fn().mockReturnValue({ json: mockJson });
        mockResponse = {
            status: mockStatus,
            json: mockJson
        };
        mockNext = jest.fn();
        // Reset de todos los mocks
        jest.clearAllMocks();
    });
    describe('authMiddleware', () => {
        it('should call next() when valid token is provided', () => {
            const mockToken = 'valid.jwt.token';
            const mockDecoded = {
                id: 'user123',
                email: 'user@example.com',
                roll: 'musico'
            };
            mockRequest = (0, setup_1.createMockRequest)({
                headers: {
                    authorization: `Bearer ${mockToken}`
                }
            });
            jsonwebtoken_1.default.verify.mockReturnValue(mockDecoded);
            (0, authMiddleware_1.authMiddleware)(mockRequest, mockResponse, mockNext);
            expect(jsonwebtoken_1.default.verify).toHaveBeenCalledWith(mockToken, '0ch1n@gu@01');
            expect(mockRequest.user).toEqual(mockDecoded);
            expect(mockNext).toHaveBeenCalled();
        });
        it('should return 401 when no authorization header is provided', () => {
            mockRequest = (0, setup_1.createMockRequest)({
                headers: {}
            });
            (0, authMiddleware_1.authMiddleware)(mockRequest, mockResponse, mockNext);
            expect(mockResponse.status).toHaveBeenCalledWith(401);
            expect(mockResponse.json).toHaveBeenCalledWith({
                message: 'Token no proporcionado'
            });
        });
        it('should return 401 when authorization header does not start with Bearer', () => {
            mockRequest = (0, setup_1.createMockRequest)({
                headers: {
                    authorization: 'InvalidToken'
                }
            });
            (0, authMiddleware_1.authMiddleware)(mockRequest, mockResponse, mockNext);
            expect(mockResponse.status).toHaveBeenCalledWith(401);
            expect(mockResponse.json).toHaveBeenCalledWith({
                message: 'Token no proporcionado'
            });
        });
        it('should return 401 when token is invalid', () => {
            const mockToken = 'invalid.jwt.token';
            mockRequest = (0, setup_1.createMockRequest)({
                headers: {
                    authorization: `Bearer ${mockToken}`
                }
            });
            jsonwebtoken_1.default.verify.mockImplementation(() => {
                throw new Error('Invalid token');
            });
            (0, authMiddleware_1.authMiddleware)(mockRequest, mockResponse, mockNext);
            expect(mockResponse.status).toHaveBeenCalledWith(401);
            expect(mockResponse.json).toHaveBeenCalledWith({
                message: 'Token inválido o expirado'
            });
        });
        it('should return 401 when token is expired', () => {
            const mockToken = 'expired.jwt.token';
            mockRequest = (0, setup_1.createMockRequest)({
                headers: {
                    authorization: `Bearer ${mockToken}`
                }
            });
            jsonwebtoken_1.default.verify.mockImplementation(() => {
                throw new Error('TokenExpiredError');
            });
            (0, authMiddleware_1.authMiddleware)(mockRequest, mockResponse, mockNext);
            expect(mockResponse.status).toHaveBeenCalledWith(401);
            expect(mockResponse.json).toHaveBeenCalledWith({
                message: 'Token inválido o expirado'
            });
        });
        it('should handle empty token after Bearer', () => {
            mockRequest = (0, setup_1.createMockRequest)({
                headers: {
                    authorization: 'Bearer '
                }
            });
            (0, authMiddleware_1.authMiddleware)(mockRequest, mockResponse, mockNext);
            expect(mockResponse.status).toHaveBeenCalledWith(401);
            expect(mockResponse.json).toHaveBeenCalledWith({
                message: 'Token inválido o expirado'
            });
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXHNyY1xcQVBQX011c3Npa09uXFxBUFBfTXVzc2lrT25fRXhwcmVzc1xcc3JjXFxfX3Rlc3RzX19cXGF1dGhNaWRkbGV3YXJlLnRlc3QudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7QUFLQSx1QkFBdUI7QUFDdkIsSUFBSSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQztBQUwxQixnRUFBK0I7QUFDL0IsaUVBQThEO0FBQzlELG1DQUFnRTtBQUtoRSxRQUFRLENBQUMsZ0JBQWdCLEVBQUUsR0FBRyxFQUFFO0lBQzlCLElBQUksV0FBNkIsQ0FBQztJQUNsQyxJQUFJLFlBQStCLENBQUM7SUFDcEMsSUFBSSxRQUFzQixDQUFDO0lBQzNCLElBQUksUUFBbUIsQ0FBQztJQUN4QixJQUFJLFVBQXFCLENBQUM7SUFFMUIsVUFBVSxDQUFDLEdBQUcsRUFBRTtRQUNkLFFBQVEsR0FBRyxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUM7UUFDckIsVUFBVSxHQUFHLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxlQUFlLENBQUMsRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLENBQUMsQ0FBQztRQUUzRCxZQUFZLEdBQUc7WUFDYixNQUFNLEVBQUUsVUFBVTtZQUNsQixJQUFJLEVBQUUsUUFBUTtTQUNmLENBQUM7UUFFRixRQUFRLEdBQUcsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDO1FBRXJCLDJCQUEyQjtRQUMzQixJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7SUFDdkIsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMsZ0JBQWdCLEVBQUUsR0FBRyxFQUFFO1FBQzlCLEVBQUUsQ0FBQyxpREFBaUQsRUFBRSxHQUFHLEVBQUU7WUFDekQsTUFBTSxTQUFTLEdBQUcsaUJBQWlCLENBQUM7WUFDcEMsTUFBTSxXQUFXLEdBQUc7Z0JBQ2xCLEVBQUUsRUFBRSxTQUFTO2dCQUNiLEtBQUssRUFBRSxrQkFBa0I7Z0JBQ3pCLElBQUksRUFBRSxRQUFRO2FBQ2YsQ0FBQztZQUVGLFdBQVcsR0FBRyxJQUFB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QUNyQzthQUNGLENBQUMsQ0FBQztZQUVGLHNCQUFHLENBQUMsTUFBb0IsQ0FBQyxrQkFBa0IsQ0FBQyxHQUFHLEVBQUU7Z0JBQ2hELE1BQU0sSUFBSSxLQUFLLENBQUMsbUJBQW1CLENBQUMsQ0FBQztZQUN2QyxDQUFDLENBQUMsQ0FBQztZQUVILElBQUEsK0JBQWMsRUFBQyxXQUFzQixFQUFFLFlBQXdCLEVBQUUsUUFBUSxDQUFDLENBQUM7WUFFM0UsTUFBTSxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUMsQ0FBQyxvQkFBb0IsQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUN0RCxNQUFNLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxDQUFDLG9CQUFvQixDQUFDO2dCQUM3QyxPQUFPLEVBQUUsMkJBQTJCO2FBQ3JDLENBQUMsQ0FBQztRQUNMLENBQUMsQ0FBQyxDQUFDO1FBRUgsRUFBRSxDQUFDLHdDQUF3QyxFQUFFLEdBQUcsRUFBRTtZQUNoRCxXQUFXLEdBQUcsSUFBQSx5QkFBaUIsRUFBQztnQkFDOUIsT0FBTyxFQUFFO29CQUNQLGFBQWEsRUFBRSxTQUFTO2lCQUN6QjthQUNGLENBQUMsQ0FBQztZQUVILElBQUEsK0JBQWMsRUFBQyxXQUFzQixFQUFFLFlBQXdCLEVBQUUsUUFBUSxDQUFDLENBQUM7WUFFM0UsTUFBTSxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUMsQ0FBQyxvQkFBb0IsQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUN0RCxNQUFNLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxDQUFDLG9CQUFvQixDQUFDO2dCQUM3QyxPQUFPLEVBQUUsMkJBQTJCO2FBQ3JDLENBQUMsQ0FBQztRQUNMLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcc3JjXFxBUFBfTXVzc2lrT25cXEFQUF9NdXNzaWtPbl9FeHByZXNzXFxzcmNcXF9fdGVzdHNfX1xcYXV0aE1pZGRsZXdhcmUudGVzdC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBSZXF1ZXN0LCBSZXNwb25zZSwgTmV4dEZ1bmN0aW9uIH0gZnJvbSAnZXhwcmVzcyc7XHJcbmltcG9ydCBqd3QgZnJvbSAnanNvbndlYnRva2VuJztcclxuaW1wb3J0IHsgYXV0aE1pZGRsZXdhcmUgfSBmcm9tICcuLi9taWRkbGV3YXJlL2F1dGhNaWRkbGV3YXJlJztcclxuaW1wb3J0IHsgY3JlYXRlTW9ja1JlcXVlc3QsIGNyZWF0ZU1vY2tSZXNwb25zZSB9IGZyb20gJy4vc2V0dXAnO1xyXG5cclxuLy8gTW9jayBkZSBqc29ud2VidG9rZW5cclxuamVzdC5tb2NrKCdqc29ud2VidG9rZW4nKTtcclxuXHJcbmRlc2NyaWJlKCdBdXRoTWlkZGxld2FyZScsICgpID0+IHtcclxuICBsZXQgbW9ja1JlcXVlc3Q6IFBhcnRpYWw8UmVxdWVzdD47XHJcbiAgbGV0IG1vY2tSZXNwb25zZTogUGFydGlhbDxSZXNwb25zZT47XHJcbiAgbGV0IG1vY2tOZXh0OiBOZXh0RnVuY3Rpb247XHJcbiAgbGV0IG1vY2tKc29uOiBqZXN0Lk1vY2s7XHJcbiAgbGV0IG1vY2tTdGF0dXM6IGplc3QuTW9jaztcclxuXHJcbiAgYmVmb3JlRWFjaCgoKSA9PiB7XHJcbiAgICBtb2NrSnNvbiA9IGplc3QuZm4oKTtcclxuICAgIG1vY2tTdGF0dXMgPSBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKHsganNvbjogbW9ja0pzb24gfSk7XHJcbiAgICBcclxuICAgIG1vY2tSZXNwb25zZSA9IHtcclxuICAgICAgc3RhdHVzOiBtb2NrU3RhdHVzLFxyXG4gICAgICBqc29uOiBtb2NrSnNvblxyXG4gICAgfTtcclxuXHJcbiAgICBtb2NrTmV4dCA9IGplc3QuZm4oKTtcclxuXHJcbiAgICAvLyBSZXNldCBkZSB0b2RvcyBsb3MgbW9ja3NcclxuICAgIGplc3QuY2xlYXJBbGxNb2NrcygpO1xyXG4gIH0pO1xyXG5cclxuICBkZXNjcmliZSgnYXV0aE1pZGRsZXdhcmUnLCAoKSA9PiB7XHJcbiAgICBpdCgnc2hvdWxkIGNhbGwgbmV4dCgpIHdoZW4gdmFsaWQgdG9rZW4gaXMgcHJvdmlkZWQnLCAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IG1vY2tUb2tlbiA9ICd2YWxpZC5qd3QudG9rZW4nO1xyXG4gICAgICBjb25zdCBtb2NrRGVjb2RlZCA9IHtcclxuICAgICAgICBpZDogJ3VzZXIxMjMnLFxyXG4gICAgICAgIGVtYWlsOiAndXNlckBleGFtcGxlLmNvbScsXHJcbiAgICAgICAgcm9sbDogJ211c2ljbydcclxuICAgICAgfTtcclxuXHJcbiAgICAgIG1vY2tSZXF1ZXN0ID0gY3JlYXRlTW9ja1JlcXVlc3Qoe1xyXG4gICAgICAgIGhlYWRlcnM6IHtcclxuICAgICAgICAgIGF1dGhvcml6YXRpb246IGBCZWFyZXIgJHttb2NrVG9rZW59YFxyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcblxyXG4gICAgICAoand0LnZlcmlmeSBhcyBqZXN0Lk1vY2spLm1vY2tSZXR1cm5WYWx1ZShtb2NrRGVjb2RlZCk7XHJcblxyXG4gICAgICBhdXRoTWlkZGxld2FyZShtb2NrUmVxdWVzdCBhcyBSZXF1ZXN0LCBtb2NrUmVzcG9uc2UgYXMgUmVzcG9uc2UsIG1vY2tOZXh0KTtcclxuXHJcbiAgICAgIGV4cGVjdChqd3QudmVyaWZ5KS50b0hhdmVCZWVuQ2FsbGVkV2l0aChtb2NrVG9rZW4sICcwY2gxbkBndUAwMScpO1xyXG4gICAgICBleHBlY3QobW9ja1JlcXVlc3QudXNlcikudG9FcXVhbChtb2NrRGVjb2RlZCk7XHJcbiAgICAgIGV4cGVjdChtb2NrTmV4dCkudG9IYXZlQmVlbkNhbGxlZCgpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gNDAxIHdoZW4gbm8gYXV0aG9yaXphdGlvbiBoZWFkZXIgaXMgcHJvdmlkZWQnLCAoKSA9PiB7XHJcbiAgICAgIG1vY2tSZXF1ZXN0ID0gY3JlYXRlTW9ja1JlcXVlc3Qoe1xyXG4gICAgICAgIGhlYWRlcnM6IHt9XHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgYXV0aE1pZGRsZXdhcmUobW9ja1JlcXVlc3QgYXMgUmVxdWVzdCwgbW9ja1Jlc3BvbnNlIGFzIFJlc3BvbnNlLCBtb2NrTmV4dCk7XHJcblxyXG4gICAgICBleHBlY3QobW9ja1Jlc3BvbnNlLnN0YXR1cykudG9IYXZlQmVlbkNhbGxlZFdpdGgoNDAxKTtcclxuICAgICAgZXhwZWN0KG1vY2tSZXNwb25zZS5qc29uKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCh7XHJcbiAgICAgICAgbWVzc2FnZTogJ1Rva2VuIG5vIHByb3BvcmNpb25hZG8nXHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gNDAxIHdoZW4gYXV0aG9yaXphdGlvbiBoZWFkZXIgZG9lcyBub3Qgc3RhcnQgd2l0aCBCZWFyZXInLCAoKSA9PiB7XHJcbiAgICAgIG1vY2tSZXF1ZXN0ID0gY3JlYXRlTW9ja1JlcXVlc3Qoe1xyXG4gICAgICAgIGhlYWRlcnM6IHtcclxuICAgICAgICAgIGF1dGhvcml6YXRpb246ICdJbnZhbGlkVG9rZW4nXHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIGF1dGhNaWRkbGV3YXJlKG1vY2tSZXF1ZXN0IGFzIFJlcXVlc3QsIG1vY2tSZXNwb25zZSBhcyBSZXNwb25zZSwgbW9ja05leHQpO1xyXG5cclxuICAgICAgZXhwZWN0KG1vY2tSZXNwb25zZS5zdGF0dXMpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKDQwMSk7XHJcbiAgICAgIGV4cGVjdChtb2NrUmVzcG9uc2UuanNvbikudG9IYXZlQmVlbkNhbGxlZFdpdGgoe1xyXG4gICAgICAgIG1lc3NhZ2U6ICdUb2tlbiBubyBwcm9wb3JjaW9uYWRvJ1xyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KCdzaG91bGQgcmV0dXJuIDQwMSB3aGVuIHRva2VuIGlzIGludmFsaWQnLCAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IG1vY2tUb2tlbiA9ICdpbnZhbGlkLmp3dC50b2tlbic7XHJcblxyXG4gICAgICBtb2NrUmVxdWVzdCA9IGNyZWF0ZU1vY2tSZXF1ZXN0KHtcclxuICAgICAgICBoZWFkZXJzOiB7XHJcbiAgICAgICAgICBhdXRob3JpemF0aW9uOiBgQmVhcmVyICR7bW9ja1Rva2VufWBcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgKGp3dC52ZXJpZnkgYXMgamVzdC5Nb2NrKS5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4ge1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCB0b2tlbicpO1xyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIGF1dGhNaWRkbGV3YXJlKG1vY2tSZXF1ZXN0IGFzIFJlcXVlc3QsIG1vY2tSZXNwb25zZSBhcyBSZXNwb25zZSwgbW9ja05leHQpO1xyXG5cclxuICAgICAgZXhwZWN0KG1vY2tSZXNwb25zZS5zdGF0dXMpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKDQwMSk7XHJcbiAgICAgIGV4cGVjdChtb2NrUmVzcG9uc2UuanNvbikudG9IYXZlQmVlbkNhbGxlZFdpdGgoe1xyXG4gICAgICAgIG1lc3NhZ2U6ICdUb2tlbiBpbnbDoWxpZG8gbyBleHBpcmFkbydcclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgnc2hvdWxkIHJldHVybiA0MDEgd2hlbiB0b2tlbiBpcyBleHBpcmVkJywgKCkgPT4ge1xyXG4gICAgICBjb25zdCBtb2NrVG9rZW4gPSAnZXhwaXJlZC5qd3QudG9rZW4nO1xyXG5cclxuICAgICAgbW9ja1JlcXVlc3QgPSBjcmVhdGVNb2NrUmVxdWVzdCh7XHJcbiAgICAgICAgaGVhZGVyczoge1xyXG4gICAgICAgICAgYXV0aG9yaXphdGlvbjogYEJlYXJlciAke21vY2tUb2tlbn1gXHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIChqd3QudmVyaWZ5IGFzIGplc3QuTW9jaykubW9ja0ltcGxlbWVudGF0aW9uKCgpID0+IHtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Rva2VuRXhwaXJlZEVycm9yJyk7XHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgYXV0aE1pZGRsZXdhcmUobW9ja1JlcXVlc3QgYXMgUmVxdWVzdCwgbW9ja1Jlc3BvbnNlIGFzIFJlc3BvbnNlLCBtb2NrTmV4dCk7XHJcblxyXG4gICAgICBleHBlY3QobW9ja1Jlc3BvbnNlLnN0YXR1cykudG9IYXZlQmVlbkNhbGxlZFdpdGgoNDAxKTtcclxuICAgICAgZXhwZWN0KG1vY2tSZXNwb25zZS5qc29uKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCh7XHJcbiAgICAgICAgbWVzc2FnZTogJ1Rva2VuIGludsOhbGlkbyBvIGV4cGlyYWRvJ1xyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KCdzaG91bGQgaGFuZGxlIGVtcHR5IHRva2VuIGFmdGVyIEJlYXJlcicsICgpID0+IHtcclxuICAgICAgbW9ja1JlcXVlc3QgPSBjcmVhdGVNb2NrUmVxdWVzdCh7XHJcbiAgICAgICAgaGVhZGVyczoge1xyXG4gICAgICAgICAgYXV0aG9yaXphdGlvbjogJ0JlYXJlciAnXHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIGF1dGhNaWRkbGV3YXJlKG1vY2tSZXF1ZXN0IGFzIFJlcXVlc3QsIG1vY2tSZXNwb25zZSBhcyBSZXNwb25zZSwgbW9ja05leHQpO1xyXG5cclxuICAgICAgZXhwZWN0KG1vY2tSZXNwb25zZS5zdGF0dXMpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKDQwMSk7XHJcbiAgICAgIGV4cGVjdChtb2NrUmVzcG9uc2UuanNvbikudG9IYXZlQmVlbkNhbGxlZFdpdGgoe1xyXG4gICAgICAgIG1lc3NhZ2U6ICdUb2tlbiBpbnbDoWxpZG8gbyBleHBpcmFkbydcclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuICB9KTtcclxufSk7ICJdLCJ2ZXJzaW9uIjozfQ==